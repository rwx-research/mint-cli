tool-cache:
  vault: mint_cli_main

tasks:
  - key: code
    call: mint/git-clone 1.2.3
    with:
      repository: https://github.com/rwx-research/mint.git
      ref: main
      github-access-token: ${{ github.token }}

  - key: tool-versions
    use: code
    run: |
      grep nodejs .tool-versions | awk '{print $2}' | tee $MINT_VALUES/nodejs
    filter:
      - .tool-versions

  - key: node
    call: mint/install-node 1.0.7
    with:
      node-version: ${{ tasks.tool-versions.values.nodejs }}

  - key: install-yaml
    use: node
    run: npm install -g yaml

  - key: generate-bigtest
    use: [code, install-yaml]
    run: NODE_PATH=$(npm root -g) node .mint/generate-bigtest-tasks.js >> "${MINT_DYNAMIC_TASKS}/tasks.yml"
    env:
      MINT_REF: main
      CLOUD_REF: main
      CLI_REF: ${{ init.commit-sha }}
    filter:
      - .mint/generate-bigtest-tasks.js
